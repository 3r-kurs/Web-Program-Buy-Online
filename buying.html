<!DOCTYPE html>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Buying</title>
<link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
<link rel="stylesheet" href="styles.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="utils.js"></script>

<script>
    function init() {
        $.ajax({
            type: "GET",
            url: "buying.php",
            success: function (items) {
                items = JSON.parse(items);
                let table = document.getElementById("tableContents");
                table.innerHTML =
                    "<tr><th>No.</th><th>Name</th><th>Description</th><th>Price</th><th>Quantity</th><th>In Cart</th></tr>";
                let num = 1;
                items.forEach((element) => {
                    let row = table.insertRow(-1);
                    let number = row.insertCell(0);
                    number.innerText = num;
                    number.style = "width: 100px;";
                    for (var key in element) {
                        if (key == "id") {
                            continue;
                        }
                        let col = row.insertCell(-1);
                        col.style = "width: 100px;";
                        col.innerText = element[key];
                    }
                    let inCart = row.insertCell(-1);
                    inCart.style = "flex:inline";
                    var rmv = document.createElement("button");
                    rmv.type = "button";
                    rmv.className = "btn btn-default";
                    rmv.value = "Remove from cart";
                    rmv.style =
                        "border-radius:10px; height:30px; width:30px; line-height:30px;text-align:center; padding:0;";
                    rmv.innerText = "-";
                    rmv.onclick = function () {
                        let cart = JSON.parse(
                            localStorage.getItem("inCart"),
                            reviver
                        );
                        console.log(cart);
                        if (cart == null) {
                            cart = new Map();
                        }
                        count =
                            cart.get(element["id"]) == undefined
                                ? 0
                                : cart.get(element["id"]);
                        console.log(element["id"]);
                        cart.set(element["id"], count - 1);
                        console.log(cart);
                        console.log(JSON.stringify(cart, replacer));
                        localStorage.setItem(
                            "inCart",
                            JSON.stringify(cart, replacer)
                        );
                    };

                    var cnt = document.createElement("span");
                    cnt.innerText =
                        localStorage.getItem("inCart") != null
                            ? JSON.parse(localStorage.getItem("inCart"))[
                                  element["id"]
                              ]
                            : 0;
                    cnt.style =
                        "width:fit-content; margin-left:10px; margin-right:10px";

                    var add = document.createElement("button");
                    add.type = "button";
                    add.className = "btn btn-default";
                    add.value = "Add to cart";
                    add.style =
                        "border-radius:10px; height:30px; width:30px; line-height:30px;text-align:center; padding:0";
                    add.innerText = "+";
                    add.onclick = function () {
                        var cart = localStorage.getItem("inCart");
                        if (cart == null) {
                            cart = new Map();
                        }
                        cart.set(element["id"], cart.get(element["id"]) + 1);
                    };

                    inCart.style = "width: 100px;";
                    inCart.appendChild(rmv);
                    inCart.appendChild(cnt);
                    inCart.appendChild(add);
                    num++;
                });
            },
            error: function (xhr, statusCode, status) {
                showAlert(xhr);
            },
        });
    }
    init();
    setInterval(() => {
        init();
    }, 10000);
</script>

<style>
    td,
    th {
        border-bottom: 1px solid #aaa;
        border-top: 1px solid #aaa;
        border-collapse: collapse;
        text-align: center;
        height: 40px;
    }
</style>

<html>
    <body>
        <script>
            Header();
        </script>
        <div
            class="container"
            style="
                width: 60%;
                margin-top: 20vh;
                height: 70vh;
                overflow: auto;
                margin-top: 15vh;
                background-color: white;
                border-radius: 20px;
                box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.1),
                    0 6px 20px 0 rgba(0, 0, 0, 0.09);
            ">
            <table
                id="tableContents"
                class="table"
                style="text-align: center; margin-top: 8px"></table>
        </div>
        <script>
            Alert();
        </script>
    </body>
</html>
